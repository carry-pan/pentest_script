import json
import time
import requests
import sys
import csv,numpy.compat.setup
 


def banner():
    print('''

                                              _                _    
 _____      ____ _  __ _  __ _  ___ _ __     | |__   __ _  ___| | __
/ __\ \ /\ / / _` |/ _` |/ _` |/ _ \ '__|____| '_ \ / _` |/ __| |/ /
\__ \\ V  V / (_| | (_| | (_| |  __/ | |_____| | | | (_| | (__|   < 
|___/ \_/\_/ \__,_|\__, |\__, |\___|_|       |_| |_|\__,_|\___|_|\_\\
                   |___/ |___/                                      
                                                            by jayus
    ''')

def get_specs(url):#获取标准列表  
    try:
        header = {"User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.13; rv:85.0) Gecko/20100101 Firefox/85.0"}
        url = url + "/swagger-resources"
        requests.packages.urllib3.disable_warnings()#解决InsecureRequestWarning警告
        res = requests.get(url, headers=header, verify=False, timeout=5)
        #print(res.text)
        specs = json.loads(res.text)
        # for spec in specs:
        #     print(spec)#{'name': 'kt-research-biz', 'url': '/research/v2/api-docs', 'swaggerVersion': '2.0', 'location': '/research/v2/api-docs'}
        return specs
    except:
        print('获取接口地址失败')

def check_spec(spec_url,url,f):#前一个是接口文档，用于分析，后一个是文档对应的实际接口请求地址
    requests.packages.urllib3.disable_warnings()#解决InsecureRequestWarning警告
    res = requests.get(url = spec_url, verify=False)
    try:
        paths = json.loads(res.text)['paths']
        print("[+] : 此标准下共有 %d 个接口"%(len(paths)))
    except:
        print("此标准为空")
        return 0

    for path in paths:
        print("[+] : 开始测试接口 %s " %(path))
        methods = paths[path]
        for method in methods:
            tags = paths[path][method]['tags'][0]
            summary = paths[path][method]['summary']
            operationId = paths[path][method]['operationId']
            if 'consumes' in paths[path][method].keys():#json格式
                consumes = paths[path][method]['consumes'][0]
            else:
                consumes = '0'     
            if consumes != '0':

                json_string = '''{
                              "contractNumber": "string",
                              "createdBy": "string",
                              "createdTime": "2021-02-01T09:33:58.398Z",
                              "cutoffDate": "2021-02-01T09:33:58.398Z",
                              "delFlag": "string",
                              "dispatchForm": "string",
                              "dispatchUnit": "string",
                              "effectDate": "2021-02-01T09:33:58.398Z",
                              "fileList": "string",
                              "id": 0,
                              "makeDate": "2021-02-01T09:33:58.398Z",
                              "manageMethod": "string",
                              "name": "string",
                              "peopleNumber": "string",
                              "remark": "string",
                              "title": "string",
                              "updatedBy": "string",
                              "updatedTime": "2021-02-01T09:33:58.398Z"
                            }'''

                if method == "post":
                    requests.packages.urllib3.disable_warnings()
                    res = requests.post(url = url + path , data = json_string, verify=False)
                elif method == "put":
                    requests.packages.urllib3.disable_warnings()
                    res = requests.put(url = url + path , data = json_string, verify=False)
                try:#post居然也可能没参数
                    row = [spec_url,summary,path,method,consumes,url + path,str(len(paths[path][method]['parameters'])),json_string,res.status_code,res.text]
                except:
                    row = [spec_url,summary,path,method,consumes,url + path,'0',json_string,res.status_code,res.text]
                writer.writerow(row)
                

            else:#不是json传输
                if "{" in path:
                    parameter = paths[path][method]['parameters'][0]
                    try:
                        if parameter['type'] == "boolean":#布尔型全为true，string和数字全部为1
                            tmp = "true"
                        else:
                            tmp = "1"
                    except:
                        tmp = "{1}"
                    if method == 'get':
                        requests.packages.urllib3.disable_warnings()
                        res = requests.get(url = url + path[:path.index('{')] + tmp, verify=False)
                    elif method == 'delete':
                        requests.packages.urllib3.disable_warnings()
                        res = requests.delete(url = url + path[:path.index('{')] + tmp, verify=False)
                    row = [spec_url,summary,path,method,consumes,url + path[:path.index('{')],str(len(paths[path][method]['parameters'])),"",res.status_code,res.text]
                    writer.writerow(row)

                else:
                    query_string = ''
                    if 'parameters' in paths[path][method]:
                        parameters = paths[path][method]['parameters']
                        num_of_param = len(parameters)
                        for parameter in parameters:
                            try:
                                if parameter['type'] == "boolean":#布尔型全为true，string和数字全部为1
                                    query_string += "&%s=true"%(parameter['name'])
                                else:
                                    query_string += "&%s=1"%(parameter['name'])
                            except:
                                query_string += "&%s={1}"%(parameter['name'])
                    else:
                        query_string = ''
                        num_of_param = 0
                    query_string = query_string[1:]
                    if method == "get":
                        requests.packages.urllib3.disable_warnings()
                        res = requests.get(url = url + path + "?" + query_string, verify=False)
                        # print(method)
                    elif method == "delete":
                        requests.packages.urllib3.disable_warnings()
                        res = requests.delete(url = url + path + "?" + query_string, verify=False)

                    row = [spec_url,summary,path,method,consumes,url + path + "?" + query_string,str(num_of_param),"",res.status_code,res.text]
                    writer.writerow(row)
        time.sleep(0)
if __name__ == '__main__':
    banner()
    url = sys.argv[1]
    specs = get_specs(url)
    print("[+] 共抓取到 %d 个标准"%(len(specs)))

    f = open(url.split(':')[1].split('//')[1] + '.csv','w',newline='',encoding='gb18030')#写到csv中
    writer = csv.writer(f)
    try:
        writer.writerow(["标准","summary","path","method","consumes","url","num of params","data","status_code","response"])
        for spec in specs:
            if spec['url'] != '':
                spec_url = url + spec['url']
                pre = spec['url'].split('/')[1]
                print("[+] : 开始测试 %s 标准"%(spec_url))
                check_spec(spec_url,url + "/" + pre,f)
            else:
                print('接口获取失败')
    except Exception as e:
        print(e)